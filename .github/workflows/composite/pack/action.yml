name: Pack Project
description: "Build and push nuget"

inputs:
  project:
    description: "Project name"
    required: true
  nugetapikey:
    description: "nuget API key"
    required: true

runs:
  using: "composite"
  steps:
    - name: Get tag
      id: tag
      uses: dawidd6/action-get-tag@v1
      with:
        # Optionally strip `v` prefix
        strip_v: true
      
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v3
          
    - name: Install dependencies
      run: dotnet restore

    - name: dotnet build ${{inputs.project}}
      run: dotnet build src/${{inputs.project}} --configuration Release --no-restore

    - name: dotnet test ${{inputs.project}}
      run: dotnet test src/${{inputs.project}}
      
    - name: update version in csproj
      id: package_version
      uses: KageKirin/set-csproj-version@v0
      with:
        file: src/${{inputs.project}}/${{inputs.project}}.csproj
        version: ${{ steps.tag.outputs.tag }}

    - name: dotnet pack ${{inputs.project}}
      run: dotnet pack src/${{inputs.project}} -c Release --no-build
      
    - name: Publish Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{inputs.project}}-packages
        path: '**/${{inputs.project}}/bin/**/*.*nupkg'
      
    - name: Publish
      run: dotnet nuget push **/${{inputs.project}}/bin/**/*.nupkg -k ${{ secrets.nugetapikey }} -s https://api.nuget.org/v3/index.json

    - name: commit new version file
      uses: stefanzweifel/git-auto-commit-action@v4.14.0
      with:
        # Commit message
        commit_message: "bump version"
        # Commit options (eg. --no-verify)
        branch: main

