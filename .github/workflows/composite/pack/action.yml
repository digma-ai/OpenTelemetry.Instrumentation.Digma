name: Pack Project
description: "Build and push nuget"

inputs:
  project:
    description: "Project name"
    required: true
  version:
    description: "Project Version"
    required: true
  nugetapikey:
    description: "nuget API key"
    required: true

runs:
  using: "composite"
  steps:
 
    
  # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
  #- uses: actions/checkout@v3
        
  - name: Install dependencies
    shell: bash
    run: dotnet restore

  - name: dotnet build ${{inputs.project}}  
    shell: bash
    run: dotnet build src/${{inputs.project}} --configuration Release --no-restore

  - name: dotnet test ${{inputs.project}}
    shell: bash
    run: dotnet test src/${{inputs.project}}
    
  - name: update version in csproj
    id: package_version
    uses: KageKirin/set-csproj-version@v0
    with:
      file: src/${{inputs.project}}/${{inputs.project}}.csproj
      version: ${{ inputs.version }}

  - name: dotnet pack ${{inputs.project}}
    shell: bash
    run: dotnet pack src/${{inputs.project}} -c Release --no-build
    
  - name: Publish Artifacts
    uses: actions/upload-artifact@v3
    with:
      name: ${{inputs.project}}-packages
      path: '**/${{inputs.project}}/bin/**/*.*nupkg'
    
  - name: Publish
    shell: bash
    run: dotnet nuget push **/${{inputs.project}}/bin/**/*.nupkg -k ${{ inputs.nugetapikey }} -s https://api.nuget.org/v3/index.json 

  - name: commit new version file
    uses: stefanzweifel/git-auto-commit-action@v4.14.0
    with:
      # Commit message
      commit_message: "bump version"
      # Commit options (eg. --no-verify)
      branch: main

